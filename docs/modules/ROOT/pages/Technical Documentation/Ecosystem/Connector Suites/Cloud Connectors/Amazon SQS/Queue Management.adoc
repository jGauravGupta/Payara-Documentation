= Managing Queues with Cloud Connector

Managing queues in Amazon SQS is crucial for effective message handling. This guide outlines the process using the Java Connector Architecture (JCA) API, focusing on key operations like creating, listing, and deleting queues.

== Connection Factory Setup

To utilize the Amazon SQS API for managing queues, a connection factory must be defined using the JCA API. This involves specifying the connection factory type and resource adapter name. Additionally, AWS account details are required in the properties of the corresponding JMS resource definitions.

[source, java]
----
@ConnectionFactoryDefinition ( 
  name = "java:app/amazonsqs/factory",
  interfaceName = "fish.payara.cloud.connectors.amazonsqs.api.AmazonSQSConnectionFactory",
  resourceAdapter = "amazon-sqs-rar-0.8.0"
  properties = {"awsAccessKeyId=<accessKeyID>", "awsSecretKey=<secretKey>", "region=<aws-region>"}
)
@Singleton
@Startup
public class ManageSQSQueues {
 
 @Resource(lookup = "java:app/amazonsqs/factory")
 private AmazonSQSConnectionFactory factory;
 
 @PostConstruct
 public void listQueues() {
    try (AmazonSQSConnection connection = factory.createConnection()) {
        // Manage queues using AmazonSQSConnection
        ............
    }
    catch (Exception ex) {
        ex.printStackTrace();
    }
 }  
}
----

In the above example, The `@ConnectionFactoryDefinition` annotation sets up the connection factory, where properties like `awsAccessKeyId`, `awsSecretKey`, and `region` should be configured.
Within the `try` block, an instance of `AmazonSQSConnection` is created using the connection factory (`factory.createConnection()`). Subsequently, the connection is used to perform various queue management operations, such as creating a new queue, listing all queues, and deleting an existing queue.


== Create Queue

Creating a new Amazon SQS queue is a fundamental operation. The following code snippet demonstrates how to create a queue:

[source, java]
----
CreateQueueRequest createQueueRequest = new CreateQueueRequest("MyNewQueue");
CreateQueueResult createQueueResult = connection.createQueue(createQueueRequest);
System.out.println("Queue Created: " + createQueueResult);
----

In this example, "MyNewQueue" is the name of the new queue. Additional parameters can be added to customize the queue creation.

== List Queues

Listing queues provides insight into existing queues. The following code demonstrates how to list all queues and those with a specific name prefix:

[source, java]
----
// List all queues
ListQueuesResult allQueues = connection.listQueues();
System.out.println("All Queues:");
for (String queueUrl : allQueues.getQueueUrls()) {
    System.out.println(" - " + queueUrl);
}

// List queues with a specific name prefix
ListQueuesResult prefixedQueues = connection.listQueues("my-prefix");
System.out.println("Prefixed Queues:");
for (String queueUrl : prefixedQueues.getQueueUrls()) {
    System.out.println(" - " + queueUrl);
}
----

Listing queues aids in monitoring and managing existing queues, allowing for targeted actions.

== Delete Queue

Deleting an existing Amazon SQS queue is a critical operation. Ensure the complete queue URL is provided in the `DeleteQueueRequest`. The following code snippet illustrates how to delete a queue:

[source, java]
----
DeleteQueueRequest deleteQueueRequest = new DeleteQueueRequest("https://sqs.<aws-region>.amazonaws.com/xxxxx/MyQueue");
DeleteQueueResult deleteQueueResult = connection.deleteQueue(deleteQueueRequest);
System.out.println("Queue Deleted: " + deleteQueueResult);
----

Exercise caution, as deleting a queue is irreversible and results in the loss of all messages.

== List Queue Tags

Listing queue tags provides metadata about a queue. The following code snippet demonstrates how to list tags for a specific queue:

[source, java]
----
ListQueueTagsResult tagsResult = connection.listQueueTags("https://sqs.<aws-region>.amazonaws.com/xxxxx/MyQueue");
Map<String, String> tags = tagsResult.tags();
System.out.println("Queue Tags: " + tags);
----

Tags offer a way to categorize and organize queues based on specific attributes.

== Purge Queue

Purging a queue deletes all messages within it. Exercise caution, as this operation is irreversible. The following code snippet illustrates how to purge a queue:

[source, java]
----
PurgeQueueResult purgeResult = connection.purgeQueue("https://sqs.<aws-region>.amazonaws.com/xxxxx/MyQueue");
System.out.println("Queue Purged: " + purgeResult);
----

Use this operation carefully, as it removes all messages from the specified queue.

== Tag and Untag Queue

Adding and removing tags from a queue provides additional context. The following code snippet shows how to tag and untag a queue:

[source, java]
----
Map<String, String> tagsToAdd = Map.of("Environment", "Production", "Team", "Dev");
TagQueueRequest tagQueueRequest = new TagQueueRequest("https://sqs.<aws-region>.amazonaws.com/xxxxx/MyQueue", tagsToAdd);
TagQueueResult tagQueueResult = connection.tagQueue(tagQueueRequest);
System.out.println("Queue Tagged: " + tagQueueResult);

List<String> tagKeysToRemove = List.of("Environment");
UntagQueueRequest untagQueueRequest = new UntagQueueRequest("https://sqs.<aws-region>.amazonaws.com/xxxxx/MyQueue", tagKeysToRemove);
UntagQueueResult untagQueueResult = connection.untagQueue(untagQueueRequest);
System.out.println("Queue Untagged: " + untagQueueResult);
----

Tagging allows for easy classification, while untagging removes unnecessary metadata.


Effectively managing Amazon SQS queues using the JCA API empowers developers to streamline message processing and maintain a well-organized messaging system. 
For more detailed information on the Amazon SQS Java SDK, including additional features and advanced usage, refer to the official Javadocs: link:https://sdk.amazonaws.com/java/api/latest/software/amazon/awssdk/services/sqs/SqsClient.html[]
